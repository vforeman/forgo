<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icons/communication-icons.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/firebase-element/firebase-document.html">

<dom-module id="basic-account">

  <template>
    <style>
      :host {
        display: block;
        @apply(--layout-vertical);
        margin:30px 0px;
      }
      span.nickname{
        font-size:3em;
      }
      span.type{
        font-size: 1.5em;
      }
      div.linked{
        color:green;
      }
      .account-description{
        font-size: 2em;
      }
      paper-material{
        padding: 16px 16px;
      }
    </style>
      <firebase-document id="firebase_doc" location="[[location]]">
    </firebase-document>
    <div class="account-description self-center">
      Money you save goes straight into the accounts you link
    </div>
    <paper-material>
      <div>
        select an account to link to the basic savings account.
      </div>
      <template is='dom-repeat' items='{{accounts}}'>
          <div class='layout horizontal justified' >
            <paper-icon-button id='{{item._id}}' icon='communication:call-merge'
              on-click='_toggleLinked'></paper-icon-button>
            <span class='nickname'>{{item.nickname}}</span>
            <span class='type self-end'>{{item.type}}</span>
          </div>
      </template>
    </paper-material>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'basic-account',
      created: function(){
      },
      ready: function(){
      },
      behaviors: [],
      listeners:{
      },
      properties: {
        accounts: {type: Array, notify: true, observer: '_accountsChanged'},
        accountLinks: {type: Array, notify: true},
        elementName: {type: String, value: 'basic-account', notify: true},
        location: {type: String, notify: true, computed: '_location(user)'},
        user: {type: Object, notify: true}
      },
      _toggleLinked: function(e){
        console.log(e.target.id)
        var id = e.target.id;
        console.log(e);
        console.log('ETARGETID: ' + e.target.id);
        console.log('basic-account ' + id);
        this.accountLinks.forEach(function(acc){
          console.log('ID: ' + acc._id);
          if(acc._id === id) {
            acc.isLinked = !acc.isLinked;
            if(acc.isLinked){
              acc.linkedTo = this.elementName;
              this.toggleClass('linked', true, e.target.parentNode);
              this._saveLinks(acc);
            } else {
              acc.linkedTo = '';
              this.toggleClass('linked', false, e.target.parentNode);
            }
          }
        }, this);
        //console.log(e.target.parentNode)
        console.log(this.accountLinks);

      },
      _isAccountLinked: function(id){
        var ret;
        this.accountLinks.forEach(function(acc){
          if(acc._id === id){
            console.log(acc._id);
            ret = acc.isLinked;
            acc.linkedTo = this.elementName;
          }
        }, this);
        console.log("RET: " + ret)
        return ret;
      },
      _accountsChanged: function(accounts) {
        console.log('accounts changed in basic-account', accounts);
      }, _location: function(user){
        var loc = 'https://forgo.firebaseio.com/accounts/' + user.customerid;
        console.log(loc);
        return loc;
      }, _saveLinks: function(accountRef) {
        var links = accountRef;
        console.log('Basic Accounts 107');
        this.$.firebase_doc.query.update({
          '/basic/id': links._id,
          '/basic/type': links.type,
          '/basic/nickname': links.nickname,
          '/basic/rewards': links.rewards,
          '/basic/balance': links.balance,
          '/basic/customer_id': links.customer_id
        });
      }
    })
  })();
  </script>
</dom-module>
