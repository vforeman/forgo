<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="swipe-page.html">


<dom-module id="swipe-pages" attributes="selected threshold transitionDuration">
  <template>
    <link rel="stylesheet" href="swipe-pages.css">
    <div class="container">
      <div class="viewContent" id="viewContent" on-track="handleTrack">
        <content class="page" id="items" select="swipe-page"></content>
      </div>
    </div>
  </template>
  <script>
    (function(){
      'use strict';

      var isWebkit = document.body.style.webkitTransform !== undefined;

      var transitionToPosition = function(element, position){
        var transition = "translateX(" + position.toString() + "%)";
        if (isWebkit){
          element.style.webkitTransform = transition;
        }else{
          element.style.transform = transition;
        }
      };

      var transitionToPage = function(element, pageNumber, pageCount){
        transitionToPosition(element, -pageNumber / pageCount * 100);
      };

      var resetAnimations = function(element){
        if (isWebkit){
          element.style.webkitTransition = "";
        }else{
          element.style.transition = "";
        }
      };

      var setPageTransitionDuration = function(element, duration){
        if (isWebkit){
          element.style.webkitTransition = "-webkit-transform " + duration + "s ease-out";
        }else{
          element.style.transition = "transform " + duration + "s ease-out";
        }
      };

      Polymer({
        is: 'swipe-pages',

        get pageCount(){
          return this.$.items.getDistributedNodes().length;
        },

        get pageWidth(){
          return this.getBoundingClientRect().width;
        },

        properties : {
          /**
          * Specifies the index of the currently selected page
          * @attribute selected
          * @default 0
          * @type Number
          */
          selected: {type: Number, notify: true, value: 0},

          /**
          * Specifies the threshold the user must swipe in order to
          * cause a page transition.
          * Only accepts values between 0 and 1.
          * @attribute threshold
          * @default 0.3
          * @type Number
          */
          threshold: {type: Number, notify: true, value: 0.3},

          /**
          * Specifies the duration (in seconds) of the transition from one
          * page to another
          * @attribute transitionDuration
          * @default 0.3
          * @type Number
          */
          transitionDuration: {type: Number, notify: true, value: 0.3}
        },

        selectedChanged: function(oldValue, newValue){
          if (newValue >= this.pageCount || newValue < 0){
            throw "Tried to selected an undefined page.";
          }
          transitionToPage(this.$.viewContent, newValue, this.pageCount);
        },
        listener: {
          'viewContent.track': 'handleTrack'
        },

        ready: function(){
          console.log('Swipe-pages READY 178');
          setPageTransitionDuration(this.$.viewContent, this.transitionDuration);

          this.$.viewContent.style.width = "" + (this.pageCount * 100) + "%";
          console.log(this.$);

          var nodes = this.$.items._distributedNodes;
          console.log(this.$.items);
          for (var i = 0; i < nodes.length; i++){
            nodes[i].style.width = "" + (100 / this.pageCount) + "%";
          }
          console.log(nodes);
        },
        handleTrack: function(e) {
          console.log('HANDLE TRACK');
          switch(e.detail.state) {
            case 'start':
              resetAnimations(this.$.viewContent);
            break;
            case 'track':
              var isFirstPage = (this.selected === 0);
              var isLastPage  = (this.selected === (this.pageCount - 1));

              var userIsSwipingLeftwards = (event.dx < 0);
              var userIsSwipingRightwards = (event.dx > 0);

              var tryingToSwipeToLeftOfFirstPage = userIsSwipingRightwards && isFirstPage;
              var tryingToSwipeToRightOfLastPage = userIsSwipingLeftwards && isLastPage;

              var tryingToSwipeToOutOfBoundsPage = tryingToSwipeToLeftOfFirstPage || tryingToSwipeToRightOfLastPage;


              if (!tryingToSwipeToOutOfBoundsPage){
                var position = -(this.selected - (event.dx / this.pageWidth)) * 100 / this.pageCount;
                transitionToPosition(this.$.viewContent, position);
              }
            break;
            case 'end':
              var userIsSwipingLeftwards = (event.dx < 0);
              var userIsSwipingRightwards = (event.dx > 0);

              var thresholdWasCrossed = (Math.abs(event.dx) / this.pageWidth) > this.threshold;

              setPageTransitionDuration(this.$.viewContent, this.transitionDuration);

              if (thresholdWasCrossed){
                if (userIsSwipingRightwards){
                  this.selected = Math.max(this.selected - 1, 0);
                }
                if (userIsSwipingLeftwards){
                  this.selected = Math.min(this.selected + 1, this.pageCount - 1);
                }
              }else{
                transitionToPage(this.$.viewContent, this.selected, this.pageCount);
              }
            break;
          }
        }
      })
    })();
  </script>
</dom-module>
